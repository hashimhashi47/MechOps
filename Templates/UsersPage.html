<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-[#C9DDE4] to-[#D9D5F0] min-h-screen flex overflow-hidden">

  <!-- SIDEBAR -->
  {{ template "sidebar" }}

  <!-- MAIN CONTENT -->
  <main class="flex-1 p-10 overflow-y-auto">

    <!-- Header -->
    <div class="flex justify-between items-center mb-10">
      <div>
        <h2 class="text-4xl font-bold text-gray-900 tracking-tight">User Management</h2>
        <p class="text-gray-600 mt-1 text-lg">Manage all registered users ‚öôÔ∏è</p>
      </div>
    </div>

    <!-- Top Row -->
    <div class="flex justify-between mb-6">
      <h2 class="text-xl font-semibold text-gray-900">Users</h2>
      <button onclick="toggleUserForm()" class="px-4 py-2 bg-gray-900 text-white rounded-xl shadow-lg">
        + Add User
      </button>
    </div>

    <!-- User Form -->
    <form id="userForm"
      class="hidden p-6 mb-8 bg-white/60 backdrop-blur-xl border border-white/40 shadow-md rounded-3xl space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input class="p-3 border rounded-xl bg-white/70" placeholder="First Name" id="firstname" required />
        <input class="p-3 border rounded-xl bg-white/70" placeholder="Last Name" id="lastname" required />
        <input class="p-3 border rounded-xl bg-white/70" placeholder="Email" id="email" required />
        <input class="p-3 border rounded-xl bg-white/70" placeholder="Phone" id="phone" required />
        <input class="p-3 border rounded-xl bg-white/70" placeholder="Password" type="password" id="password" />
      </div>

      <button class="px-6 py-3 bg-[#3B8FE3] text-white rounded-xl shadow-md" type="submit">Save</button>
      <input type="hidden" id="userId" />
    </form>

    <!-- Users Table -->
    <section class="bg-white/60 backdrop-blur-xl border border-white/40 shadow-md rounded-3xl p-6">
      <table class="w-full text-left">
        <thead class="bg-white/60 rounded-xl">
          <tr class="text-gray-700">
            <th class="p-3">Name</th>
            <th class="p-3">Email</th>
            <th class="p-3">Phone</th>
            <th class="p-3">Actions</th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </section>

  </main>

  <script>
    // =============================
    // üöó LOAD USERS LIST
    // =============================
    async function loadUsers() {
      const res = await fetch(`/Admin/GetAllusers`);
      const data = await res.json();
      console.log("Updated users:", data.Users);
      const table = document.getElementById("usersTable");
      table.innerHTML = "";

      data.Users.forEach((u) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-300/30 hover:bg-white/60 transition';

        row.innerHTML = `
          <td class="p-4 text-gray-800">${u.firstname} ${u.lastname}</td>
          <td class="p-4 text-gray-800">${u.email}</td>
          <td class="p-4 text-gray-800">${u.phone}</td>
          <td class="p-4 flex gap-2">
            <button 
              class="bg-yellow-500 text-white px-4 py-2 rounded-xl shadow hover:bg-yellow-600 edit-btn">
              Edit
            </button>

            <button 
              class="bg-red-600 text-white px-4 py-2 rounded-xl shadow hover:bg-red-700 delete-btn">
              Delete
            </button>

            <button 
              class="bg-purple-600 text-white px-4 py-2 rounded-xl shadow hover:bg-purple-700 block-btn">
              ${u.block ? "Unblock" : "Block"}
            </button>
          </td>
        `;

        // Add event listeners with proper data binding
        row.querySelector('.edit-btn').addEventListener('click', () => {
          editUser(u.ID, u.firstname, u.lastname, u.email, u.phone);
        });

        row.querySelector('.delete-btn').addEventListener('click', () => {
          deleteUser(u.ID);
        });

        row.querySelector('.block-btn').addEventListener('click', () => {
          toggleBlock(u.ID, u.block);
        });

        table.appendChild(row);
      });
    }

    // =============================
    // ‚ú® CREATE / UPDATE USER
    // =============================
    document.getElementById("userForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const id = document.getElementById("userId").value;
      console.log("User ID:", id);

      const payload = {
        firstname: document.getElementById("firstname").value,
        lastname: document.getElementById("lastname").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        password: document.getElementById("password").value
      };

      try {
        if (id) {
          const response = await fetch(`/Admin/UpdateUsers/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const error = await response.json();
            console.error("Update failed:", error);
            alert("Failed to update user: " + (error.Error || "Unknown error"));
            return;
          }

          alert("User updated successfully!");
        } else {
          const response = await fetch(`/Admin/AddUser`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const error = await response.json();
            console.error("Create failed:", error);
            alert("Failed to create user: " + (error.Error || "Unknown error"));
            return;
          }

          alert("User created successfully!");
        }

        toggleUserForm();
        loadUsers();
      } catch (error) {
        console.error("Request failed:", error);
        alert("Request failed: " + error.message);
      }
    });

    // =============================
    // ‚úèÔ∏è EDIT USER
    // =============================
    function editUser(id, firstnameVal, lastnameVal, emailVal, phoneVal) {
      console.log("Editing user with ID:", id);

      // Show form
      document.getElementById("userForm").classList.remove("hidden");

      // Populate form fields
      document.getElementById("userId").value = id;
      document.getElementById("firstname").value = firstnameVal;
      document.getElementById("lastname").value = lastnameVal;
      document.getElementById("email").value = emailVal;
      document.getElementById("phone").value = phoneVal;
      document.getElementById("password").value = ""; // Clear password field
    }

    // =============================
    // üóë DELETE USER
    // =============================
    async function deleteUser(id) {
      if (!confirm("Are you sure you want to delete this user?")) {
        return;
      }

      try {
        const response = await fetch(`/Admin/Delete/${id}`, {
          method: "DELETE"
        });

        if (!response.ok) {
          alert("Failed to delete user");
          return;
        }

        alert("User deleted successfully!");
        loadUsers();
      } catch (error) {
        console.error("Delete failed:", error);
        alert("Delete failed: " + error.message);
      }
    }

    // =============================
    // üö´ BLOCK / UNBLOCK USER
    // =============================
    async function toggleBlock(id, currentStatus) {
      try {
        const response = await fetch(`/Admin/User/Block/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ block: !currentStatus })
        });

        if (!response.ok) {
          alert("Failed to update block status");
          return;
        }

        alert(`User ${!currentStatus ? 'blocked' : 'unblocked'} successfully!`);
        loadUsers();
      } catch (error) {
        console.error("Block toggle failed:", error);
        alert("Operation failed: " + error.message);
      }
    }

    // =============================
    // üéõ TOGGLE FORM
    // =============================
    function toggleUserForm() {
      const form = document.getElementById("userForm");
      if (form.classList.contains("hidden")) {
        form.classList.remove("hidden");
      } else {
        form.classList.add("hidden");
        resetUserForm();
      }
    }

    function resetUserForm() {
      document.getElementById("userForm").reset();
      document.getElementById("userId").value = "";
    }

    // üöÄ INITIAL LOAD
    loadUsers();
  </script>

</body>

</html>